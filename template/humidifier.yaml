- binary_sensor:
  - name: 'humidifier'
    device_class: 'moisture'
    state: >
      {% set hallValue = state_attr('binary_sensor.humidifier', 'hall_boolean') %}
      {% set bedroomValue = state_attr('binary_sensor.humidifier', 'bedroom_boolean') %}
      {% set livingValue = state_attr('binary_sensor.humidifier', 'living_boolean') %}
      {{ not(hallValue) and not(bedroomValue) and not(livingValue) }}
    icon: >
      {% set isNormalIcon = is_state('binary_sensor.humidifier', 'on') and 'mdi:water' %}
      {% set isLowIcon = is_state('binary_sensor.humidifier', 'off') and 'mdi:water-opacity' %}
      {% set defaultIcon = 'mdi:help-circle' %}
      {{ isLowIcon or isNormalIcon or defaultIcon }}
    attributes:
      hall_state: >
        {% set isVentilation = state_attr('binary_sensor.ventilation', 'hall_boolean') %}
        {% set isNightTime = state_attr('sensor.day_time', 'night_boolean') %}
        {% set isDry = state_attr('sensor.humidity', 'hall_low_boolean') %}
        {{ not(isVentilation) and not(isNightTime) and isDry }}
      bedroom_state: >
        {% set isVentilation = state_attr('binary_sensor.ventilation', 'bedroom_boolean') %}
        {% set isNightTime = state_attr('sensor.day_time', 'night_boolean') %}
        {% set isDry = state_attr('sensor.humidity', 'bedroom_low_boolean') %}
        {{ not(isVentilation) and not(isNightTime) and isDry }}
      living_state: >
        {% set isVentilation = state_attr('binary_sensor.ventilation', 'living_boolean') %}
        {% set isNightTime = state_attr('sensor.day_time', 'night_boolean') %}
        {% set isDry = state_attr('sensor.humidity', 'living_low_boolean') %}
        {{ not(isVentilation) and not(isNightTime) and isDry }}
      
      hall_boolean: "{{ is_state('input_boolean.h_hall', 'on') }}"
      bedroom_boolean: "{{ is_state('input_boolean.h_bedroom', 'on') }}"
      living_boolean: "{{ is_state('input_boolean.h_living', 'on') }}"

  - name: 'humidifier_empty'
    device_class: 'problem'
    state: >
      {% set hallValue = state_attr('binary_sensor.humidifier_empty', 'hall_boolean') %}
      {% set bedroomValue = state_attr('binary_sensor.humidifier_empty', 'bedroom_boolean') %}
      {% set livingValue = state_attr('binary_sensor.humidifier_empty', 'living_boolean') %}
      {{ hallValue or bedroomValue or livingValue }}
    icon: >
      {% set isLowIcon = is_state('binary_sensor.humidifier_empty', 'on') and 'mdi:water-opacity' %}
      {% set isNormalIcon = is_state('binary_sensor.humidifier_empty', 'off') and 'mdi:water' %}
      {% set defaultIcon = 'mdi:help-circle' %}
      {{ isLowIcon or isNormalIcon or defaultIcon }}
    attributes:
      hall_state: >
        {% set humidifierIsOn = state_attr('binary_sensor.relay', 'hall_2_sensor') %}
        {% set backlightIsOn = state_attr('binary_sensor.relay', 'hall_1_sensor') %}
        {% set humidifierMinPower = 1 %}
        {% set backlightMinPower = states('input_number.pw_offset_hall') | int(0) %}
        {% set relayMinPower = backlightMinPower + humidifierMinPower %}
        {% set sensorValue = state_attr('sensor.power', 'hall') | int(0) %}
        {% set expectedValue = iif(backlightIsOn, relayMinPower, humidifierMinPower) %}
        {{ humidifierIsOn and (sensorValue <= expectedValue) }}
      bedroom_state: >
        {% set humidifierIsOn = state_attr('binary_sensor.relay', 'bedroom_2_sensor') %}
        {% set backlightIsOn = state_attr('binary_sensor.relay', 'bedroom_1_sensor') %}
        {% set humidifierMinPower = 1 %}
        {% set backlightMinPower = states('input_number.pw_offset_bedroom') | int(0) %}
        {% set relayMinPower = backlightMinPower + humidifierMinPower %}
        {% set sensorValue = state_attr('sensor.power', 'bedroom') | int(0) %}
        {% set expectedValue = iif(backlightIsOn, relayMinPower, humidifierMinPower) %}
        {{ humidifierIsOn and (sensorValue <= expectedValue) }}
      living_state: >
        {% set humidifierIsOn = state_attr('binary_sensor.relay', 'living_1_sensor') %}
        {% set backlightIsOn = state_attr('binary_sensor.relay', 'living_2_sensor') %}
        {% set humidifierMinPower = 1 %}
        {% set backlightMinPower = states('input_number.pw_offset_living') | int(0) %}
        {% set relayMinPower = backlightMinPower + humidifierMinPower %}
        {% set sensorValue = state_attr('sensor.power', 'living') | int(0) %}
        {% set expectedValue = iif(backlightIsOn, relayMinPower, humidifierMinPower) %}
        {{ humidifierIsOn and (sensorValue <= expectedValue) }}
      
      hall_boolean: "{{ is_state('input_boolean.h_hall_empty', 'on') }}"
      bedroom_boolean: "{{ is_state('input_boolean.h_bedroom_empty', 'on') }}"
      living_boolean: "{{ is_state('input_boolean.h_living_empty', 'on') }}"

