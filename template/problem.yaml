## NETWORK
- sensor:
  - name: 'problem_network'
    device_class: 'data_rate'
    unit_of_measurement: Mbit/s
    state: "{{ state_attr('sensor.problem_network', 'download') }}"
    icon: >
      {% set isProblem = state_attr('binary_sensor.problem_network', 'problem') %}
      {{ iif(isProblem, 'mdi:speedometer-slow', 'mdi:speedometer', 'mdi:help-circle') }}
    attributes:
      download: "{{ states('sensor.speedtest_download') | float(0) | round(1) }}"
      upload: "{{ states('sensor.speedtest_upload') | float(0) | round(1) }}"
      ping: "{{ states('sensor.speedtest_ping') | float(0) | round(1) }}"

- binary_sensor:
  - name: 'problem_network'
    state: "{{ state_attr('binary_sensor.problem_network', 'problem') }}"
    icon: >
      {% set isProblem = state_attr('binary_sensor.problem_network', 'problem') %}
      {{ iif(isProblem, 'mdi:speedometer-slow', 'mdi:speedometer', 'mdi:help-circle') }}
    attributes: 
      problem: >
        {% set downloadValue = state_attr('binary_sensor.problem_network', 'download') %}
        {% set uploadValue = state_attr('binary_sensor.problem_network', 'upload') %}
        {% set pingValue = state_attr('binary_sensor.problem_network', 'ping') %}
        {{ downloadValue or uploadValue or pingValue }}
      download: >
        {% set sensorValue = state_attr('sensor.problem_network', 'download') | int(0) %}
        {% set targetValue = states('input_number.problem_network_download_target') | int(0) %}
        {{ sensorValue < targetValue }}
      upload: >
        {% set sensorValue = state_attr('sensor.problem_network', 'upload') | int(0) %}
        {% set targetValue = states('input_number.problem_network_upload_target') | int(0) %}
        {{ sensorValue < targetValue }}
      ping: >
        {% set sensorValue = state_attr('sensor.problem_network', 'ping') | int(0) %}
        {% set targetValue = states('input_number.problem_network_ping_target') | int(0) %}
        {{ sensorValue > targetValue }}

  - name: 'problem_empty'
    device_class: 'problem'
    state: >
      {% set hallValue = state_attr('binary_sensor.problem_empty', 'hall') %}
      {% set bedroomValue = state_attr('binary_sensor.problem_empty', 'bedroom') %}
      {% set livingValue = state_attr('binary_sensor.problem_empty', 'living') %}
      {{ hallValue or bedroomValue or livingValue }}
    icon: >
      {% set isLowIcon = is_state('binary_sensor.problem_empty', 'om') %}
      {{ iif(isLowIcon, 'mdi:water-opacity', 'mdi:water', 'mdi:help-circle') }}
    attributes:
      hall: >
        {% set humidifierIsOn = state_attr('binary_sensor.status_relay', 'hall_2') %}
        {% set backlightIsOn = state_attr('binary_sensor.status_relay', 'hall_1') %}
        {% set humidifierMinPower = 1 %}
        {% set backlightMinPower = states('input_number.power_offset_hall') | int(0) %}
        {% set relayMinPower = backlightMinPower + humidifierMinPower %}
        {% set sensorValue = state_attr('sensor.power', 'hall') | int(0) %}
        {% set expectedValue = iif(backlightIsOn, relayMinPower, humidifierMinPower) %}
        {{ humidifierIsOn and (sensorValue <= expectedValue) }}
      bedroom: >
        {% set humidifierIsOn = state_attr('binary_sensor.status_relay', 'bedroom_2') %}
        {% set backlightIsOn = state_attr('binary_sensor.status_relay', 'bedroom_1') %}
        {% set humidifierMinPower = 1 %}
        {% set backlightMinPower = states('input_number.power_offset_bedroom') | int(0) %}
        {% set relayMinPower = backlightMinPower + humidifierMinPower %}
        {% set sensorValue = state_attr('sensor.power', 'bedroom') | int(0) %}
        {% set expectedValue = iif(backlightIsOn, relayMinPower, humidifierMinPower) %}
        {{ humidifierIsOn and (sensorValue <= expectedValue) }}
      living: >
        {% set humidifierIsOn = state_attr('binary_sensor.status_relay', 'living_1') %}
        {% set backlightIsOn = state_attr('binary_sensor.status_relay', 'living_2') %}
        {% set humidifierMinPower = 1 %}
        {% set backlightMinPower = states('input_number.power_offset_living') | int(0) %}
        {% set relayMinPower = backlightMinPower + humidifierMinPower %}
        {% set sensorValue = state_attr('sensor.power', 'living') | int(0) %}
        {% set expectedValue = iif(backlightIsOn, relayMinPower, humidifierMinPower) %}
        {{ humidifierIsOn and (sensorValue <= expectedValue) }}


