## NIGHT_MODE SENSORS
- sensor:
  - name: 'night_mode_kitchen_last_motion'
    unit_of_measurement: 'мин. назад'
    icon: 'mdi:motion-play'
    state: "{{ ((as_timestamp(now()) - as_timestamp(states.binary_sensor.hall_motion.last_changed)) / 60) | round(0) }}"

  - name: 'night_mode_hall_last_motion'
    unit_of_measurement: 'мин. назад'
    icon: 'mdi:motion-play'
    state: "{{ ((as_timestamp(now()) - as_timestamp(states.binary_sensor.motion_kitchen.last_changed)) / 60) | round(0) }}"

- binary_sensor:
  - name: 'night_mode_auto_on'
    icon: 'mdi:play-circle'
    state: >
      {% set isNightMode = is_state('binary_sensor.night_mode_hall_boolean', 'on') %}
      {% set isNightTime = is_state('binary_sensor.date_time_night_time', 'on') %}
      {% set isTwilightTime = is_state('binary_sensor.date_time_twilight_time', 'on') %}
      {% set kitchenValue = states('sensor.night_mode_kitchen_last_motion') | int(0) %}
      {% set hallValue = states('sensor.night_mode_hall_last_motion') | int(0) %}
      {% set targetValue = states('input_number.night_mode_inaction_target') | int(0) %}
      {{ isNightMode or isNightTime or (isTwilightTime and (kitchenValue > targetValue) and (hallValue > targetValue)) }}

  - name: 'night_mode_auto_off'
    icon: 'mdi:stop-circle'
    state: >
      {% set isNightMode = is_state('binary_sensor.night_mode_hall_boolean', 'on') %}
      {% set isMorningTime = is_state('binary_sensor.date_time_morning_time', 'on') %}
      {% set isDayTime = is_state('binary_sensor.date_time_day_time', 'on') %}
      {% set isHallMotion = is_state('binary_sensor.motion_hall_boolean', 'on') %}
      {% set isKitchenMotion = is_state('binary_sensor.motion_kitchen_boolean', 'on') %}
      {{ not(isNightMode) or isDayTime or (isMorningTime and (isHallMotion or isKitchenMotion)) }}

## NIGHT_MODE BOOLEAN
  - name: 'night_mode_bedroom_boolean' 
    state: "{{ is_state('input_boolean.button_bedroom_both', 'on') }}"
    icon: >
      {% set isNightMode = is_state('binary_sensor.night_mode_bedroom_boolean', 'on') %}
      {{ iif(isNightMode, 'mdi:weather-night', 'mdi:weather-partly-cloudy', 'mdi:help-circle') }}

  - name: 'night_mode_living_boolean' 
    state: "{{ is_state('input_boolean.button_living_both', 'on') }}"
    icon: >
      {% set isNightMode = is_state('binary_sensor.night_mode_living_boolean', 'on') %}
      {{ iif(isNightMode, 'mdi:weather-night', 'mdi:weather-partly-cloudy', 'mdi:help-circle') }}

  - name: 'night_mode_hall_boolean'
    state: >
      {% set bedroomValue = is_state('binary_sensor.night_mode_bedroom_boolean', 'on') %}
      {% set livingValue = is_state('binary_sensor.night_mode_living_boolean', 'on') %}
      {{ bedroomValue or livingValue }}
    icon: >
      {% set isNightMode = is_state('binary_sensor.night_mode_hall_boolean', 'on') %}
      {{ iif(isNightMode, 'mdi:weather-night', 'mdi:weather-partly-cloudy', 'mdi:help-circle') }}
