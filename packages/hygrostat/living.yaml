hygrostat_living:
  generic_hygrostat:
  - name: hygrostat_living
    device_class: humidifier
    humidifier: switch.relay_living_l1
    target_sensor: sensor.climat_humidity_living_virtual

  input_boolean:
    hygrostat_living_is_empty:

  input_number:
    hygrostat_living_power_offset: 
      max: 60
      min: 0
      # 10

  template:
  - sensor:
    - name: hygrostat_living_power
      unique_id: hygrostat_living_power
      device_class: power
      unit_of_measurement: W
      state: "{{ states('sensor.relay_living_power') | int(1) }}"

  - binary_sensor:
    - name: hygrostat_living_is_empty
      unique_id: hygrostat_living_is_empty
      device_class: moisture
      delay_on: 00:00:05
      state: >
        {% set humidifier = is_state('switch.relay_living_l1', 'on') %}
        {% set backlight = is_state('light.light_back_living', 'on') %}
        {% set offset = states('input_number.system_power_living_virtual') | int(0) %}
        {% set power = states('sensor.hygrostat_living_power') | int(0) %}
        {% set sensor = iif(backlight, power - offset, power) %}
        {{ humidifier and (sensor <= 0) }}

  automation:
  - alias: hygrostat_living_is_empty
    mode: queued
    trigger:
    - platform: state
      entity_id: binary_sensor.hygrostat_living_is_empty
      from: "off"
      to: "on"
    action:
    - service: input_boolean.turn_on
      entity_id: input_boolean.hygrostat_living_is_empty
