intercom:
  lock:
  - platform: template
    name: hall_intercom
    value_template: "{{ is_state('input_boolean.intercom_hall_open', 'off') }}"
    unlock:
    - service: script.intercom_hall_open
    lock:
    - service: input_boolean.turn_off
      entity_id: input_boolean.intercom_hall_open

  input_boolean:
    intercom_hall_call:
    intercom_hall_open:
    intercom_hall_enabled:

  automation:
  - alias: 'intercom_hall_on'
    initial_state: true
    trigger: 
    - platform: state
      entity_id: switch.intercom_hall
      to: 'off'
    action:
    - choose:
      - conditions:
        - condition: template
          value_template: >
            {% set userId = trigger.to_state.context.user_id %}
            {% set parentId = trigger.to_state.context.parent_id %}
            {{ userId == none and parentId == none }}
        sequence:
        - service: input_boolean.turn_on
          entity_id: input_boolean.intercom_hall_call
        - delay: 00:00:01
        - service: input_boolean.turn_on
          entity_id: input_boolean.intercom_hall_call









    # - choose:
    #   - conditions:
    #     - condition: state
    #       entity_id: input_boolean.intercom_hall_enabled
    #       state: 'off'
    #     sequence:
    #     - delay: 00:00:20
    #     - service: script.intercom_hall_open



  # - alias: 'intercom_hall_off'
  #   initial_state: true
  #   trigger: 
  #   - platform: state
  #     entity_id: switch.intercom_hall
  #     to: 'off'
  #   condition:
  #   - condition: template
  #     value_template: >
  #       {% set userId = trigger.to_state.context.user_id %}
  #       {% set parentId = trigger.to_state.context.parent_id %}
  #       {{ userId == none and parentId == none }}
  #   action:
  #   - service: input_boolean.turn_off
  #     entity_id: input_boolean.intercom_hall_call

  script:
    intercom_hall_open:
      mode: 'queued'
      sequence:
      # - service: switch.turn_on
      #   entity_id: switch.intercom_hall
      - service: input_boolean.turn_on
        entity_id: input_boolean.intercom_hall_open
      - delay: 00:00:15
      - service: input_boolean.turn_off
        entity_id: input_boolean.intercom_hall_open
      # - service: switch.turn_off
      #   entity_id: switch.intercom_hall
