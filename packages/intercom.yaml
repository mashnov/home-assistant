intercom:
  input_boolean:
    intercom_hall:
    intercom_hall_auto_on:

  template:
  - trigger:
    - platform: state
      entity_id: switch.intercom_hall
    sensor:
    - name: intercom_hall_type
      state: >
        {% set userId = trigger.to_state.context.user_id %}
        {% set parentId = trigger.to_state.context.parent_id %}
        {% if userId == none and parentId == none %}
          {{ call }}
        {% else %}
          {{ open }}
        {% endif %}

  automation:
    alias: 'intercom_hall_type_detect'
    initial_state: true
    trigger: 
    - platform: state
      entity_id: switch.intercom_hall
    action:
    - service: script.console
      data:
        message: "{{ states('sensor.intercom_hall_type') }}"

  script:
    intercom_hall_open:
      mode: 'queued'
      sequence:
      - service: script.console
        data:
          message: 'ДОМОФОН'


      # - service: switch.turn_on
      #   entity_id: switch.intercom_hall
      # - delay: 00:00:15
      # - service: switch.turn_off
      #   entity_id: switch.intercom_hall

    
# Звоню в кв:
# - авто вкл
# - ждем 3 сек
# - авто выкл

# Если включен автоответ:
# - вкл - ответ
# - выкл - открытие
