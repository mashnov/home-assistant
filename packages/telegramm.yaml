telegramm:
  automation:
# ============== TELEGRAMM

  - alias: telegram_remove_callback_handler'
    initial_state: true
    trigger:
    - platform: event
      event_type: telegram_callback
    action:
    - service: script.delete_telegramm_message
      data_template:
        message_id: '{{ trigger.event.data.message.message_id }}'
        chat_id: '{{ trigger.event.data.chat_id }}'

  - alias: telegram_message_handler'
    initial_state: true
    trigger:
    - platform: event
      event_type: telegram_command
    - platform: event
      event_type: telegram_callback
    action:
    - service: script.handle_telegramm_event
      data_template:
        option: '{{ trigger.event.data.command }}'

  script:
# ============== TELEGRAMM MESSAGES
    delete_telegramm_message:
      sequence:
      - service: telegram_bot.delete_message
        data_template:
          message_id: '{{ message_id }}'
          chat_id: '{{ chat_id }}' 

# ============== TELEGRAMM ACTIONS
    handle_telegramm_event:
      sequence:
      - service: script.turn_on
        data_template:
          variables:
            options: '[{{ option }}]'
          entity_id: >
            {%- if option == '/restart' -%}
                {{ 'script.system_restart_handler' }}
            {%- elif option == '/menu' -%}
                {{ 'script.show_telegramm_home_menu' }}
            {%- elif option == '/kitchen' -%}
                {{ 'script.show_telegramm_kitchen_menu' }}
            {%- elif option == '/bath' -%}
                {{ 'script.show_telegramm_bath_menu' }}
            {%- elif option == '/toilet' -%}
                {{ 'script.show_telegramm_toilet_menu' }}
            {%- elif option == '/hall' -%}
                {{ 'script.show_telegramm_hall_menu' }}
            {%- elif option == '/bedroom' -%}
                {{ 'script.show_telegramm_bedroom_menu' }}
            {%- elif option == '/living' -%}
                {{ 'script.show_telegramm_living_menu' }}
            {%- elif option == '/balcony' -%}
                {{ 'script.show_telegramm_balcony_menu' }}
            {%- elif option == '/status' -%}
                {{ 'script.show_telegramm_status_menu' }}
            {%- endif -%}

    show_telegramm_home_menu: 
      sequence:
      - service: notify.telegram_home_group_id
        data_template:
          message: | 
            🏡 Главное меню

            🔵 Температура ........... {{ states('sensor.t_average') }} °C
            🔵 Влажность ............... {{ states('sensor.h_average') }} %
            🔵 Давление ................. {{ states('sensor.p_average') }} мм
          data:
            inline_keyboard: 
            - 'Кухня:/kitchen, Ванная:/bath'
            - 'Туалет:/toilet, Коридор:/hall'
            - 'Спальня:/bedroom, Гостиная:/living'
            - 'Балкон:/balcony,  Отчет:/status'
            - 'Закрыть:/hideMenu'

    show_telegramm_kitchen_menu: 
      sequence:
      - service: notify.telegram_home_group_id
        data_template:
          message: | 
            🥣 Кухня

            {{ iif(is_state('binary_sensor.t_kitchen_air_is_normal', 'on'), '🟢', '🔴') }} Температура ................ {{ states('sensor.t_kitchen') }} °C
            {{ iif(is_state('binary_sensor.h_kitchen_is_normal', 'on'), '🟢', '🔴') }} Влажность .................... {{ states('sensor.h_kitchen') }} %
            {{ iif(is_state('binary_sensor.p_kitchen_is_normal', 'on'), '🟢', '🟠') }} Давление ...................... {{ states('sensor.p_kitchen') }} мм
            🔵 Положение шторы ....... {{ states('sensor.curtain_kitchen_position') }} %

            {{ iif(is_state('binary_sensor.ventilation_kitchen_left_window_virtual', 'on'), '🟠 Левое окно ................... Открыто', '🟢 Левое окно ................... Закрыто') }}
            {{ iif(is_state('binary_sensor.ventilation_kitchen_right_window_virtual', 'on'), '🟠 Правое окно ................. Открыто', '🟢 Правое окно ................. Закрыто') }}

            {{ iif(is_state('binary_sensor.toplight_kitchen_light_is_on', 'on'), '🟠 Освещение ................... Включено', '🟢 Освещение ................... Выключено') }}
            {{ iif(is_state('binary_sensor.backlight_kitchen_light_is_on', 'on'), '🟠 Подсветка ..................... Включена', '🟢 Подсветка ..................... Выключена') }}
            {{ iif(is_state('binary_sensor.nightlight_kitchen_light_is_on', 'on'), '🟠 Ночник .......................... Включен', '🟢 Ночник .......................... Выключен') }}

            {{ iif(is_state('binary_sensor.solar_kitchen_sun_is_hit', 'on'), '🟠 Солнце .......................... Светит в окна', '🟢 Солнце ......................... Не попадает в окна') }}

            {{ iif(is_state('switch.kitchen_switch_right', 'on'), '🟢 Левый выключатель ..... Включен', '🔴 Левый выключатель ..... Выключен') }}
            {{ iif(is_state('switch.kitchen_switch_left', 'on'), '🟢 Правый выключатель ... Включен', '🔴 Правый выключатель ... Выключен') }}


            {{ iif(is_state('binary_sensor.occupancy_kitchen_occupancy_virtual', 'on'), '🟠 Движение ..................... Обнаружено', '🟢 Движение ..................... Не обнаружено') }}
          data:
            inline_keyboard: 
            - 'Назад:/menu, Закрыть:/hideMenu'

    show_telegramm_bath_menu: 
      sequence:
      - service: notify.telegram_home_group_id
        data_template:
          message: | 
            🛁 Ванная

            {{ iif(is_state('binary_sensor.t_bath_air_is_normal', 'on'), '🟢', '🔴') }} Температура ............... {{ states('sensor.t_bath') }} °C
            {{ iif(is_state('binary_sensor.h_bath_is_normal', 'on'), '🟢', '🔴') }} Влажность ................... {{ states('sensor.h_bath') }} %
            {{ iif(is_state('binary_sensor.p_bath_is_normal', 'on'), '🟢', '🟠') }} Давление ..................... {{ states('sensor.p_bath') }} мм
            
            {{ iif(is_state('binary_sensor.occupancy_bath_occupancy_virtual', 'on'), '🟠 Движение .................... Обнаружено', '🟢 Движение .................... Не обнаружено') }}

            {{ iif(is_state('binary_sensor.toplight_bath_light_is_on', 'on'), '🟠 Освещение .................. Включено', '🟢 Освещение .................. Выключено') }}
            {{ iif(is_state('binary_sensor.nightlight_bath_light_is_on', 'on'), '🟠 Ночник ......................... Включен', '🟢 Ночник ......................... Выключен') }}
            {{ iif(is_state('fan.hydration_toilet_fan', 'on'), '🟠 Вытяжка ....................... Включена', '🟢 Вытяжка ....................... Выключена') }}
          data:
            inline_keyboard: 
            - 'Назад:/menu, Закрыть:/hideMenu'

    show_telegramm_toilet_menu: 
      sequence:
      - service: notify.telegram_home_group_id
        data_template:
          message: | 
            🚽 Туалет 

            🔵 Температура ........... {{ states('sensor.t_average') }} °C
            🔵 Влажность ............... {{ states('sensor.h_average') }} %
            🔵 Давление ................. {{ states('sensor.p_average') }} мм
            
            {{ iif(is_state('binary_sensor.occupancy_toilet_is_occupancy', 'on'), '🔴 Состояние ............... Занято', '🟢 Состояние ............... Свободно') }}
            {{ iif(is_state('binary_sensor.hall_door', 'on'), '🟠 Дверь ....................... Открыта', '🟢 Дверь ....................... Закрыта') }}

            {{ iif(is_state('binary_sensor.toplight_toilet_light_is_on', 'on'), '🟠 Освещение .............. Включено', '🟢 Освещение .............. Выключено') }}
            {{ iif(is_state('binary_sensor.nightlight_toilet_light_is_on', 'on'), '🟠 Ночник ..................... Включен', '🟢 Ночник ..................... Выключен') }}
            {{ iif(is_state('fan.hydration_toilet_fan', 'on'), '🟠 Вытяжка ................... Включена', '🟢 Вытяжка ................... Выключена') }}
          data:
            inline_keyboard: 
            - 'Назад:/menu, Закрыть:/hideMenu'

    show_telegramm_hall_menu: 
      sequence:
      - service: notify.telegram_home_group_id
        data_template:
          message: | 
            🧥 Коридор

            {{ iif(is_state('binary_sensor.t_hall_air_is_normal', 'on'), '🟢', '🔴') }} Температура ............... {{ states('sensor.t_hall') }} °C
            {{ iif(is_state('binary_sensor.h_hall_is_normal', 'on'), '🟢', '🔴') }} Влажность ................... {{ states('sensor.h_hall') }} %
            {{ iif(is_state('binary_sensor.p_hall_is_normal', 'on'), '🟢', '🟠') }} Давление ..................... {{ states('sensor.p_hall') }} мм
            
            {{ iif(is_state('binary_sensor.hall_door', 'on'), '🟠 Входная дверь ............. Открыта', '🟢 Входная дверь ............. Закрыта') }}
            {{ iif(is_state('binary_sensor.occupancy_hall_occupancy_virtual', 'on'), '🟠 Движение ..................... Обнаружено', '🟢 Движение ..................... Не обнаружено') }}
            
            {{ iif(is_state('fan.hydration_hall_humidifier', 'on'), '🟢 Увлажнитель ................ Включен', '🟠 Увлажнитель:................ Выключен') }}
            {{ iif(is_state('binary_sensor.hydration_hall_humidifier_is_empty', 'on'), '🔴 Вода в увлажнителе .... Закончилась', '🔵 Вода в увлажнителе .... Недоступно') }}
            
            {{ iif(is_state('switch.hall_switch', 'on'), '🟢 Выключатель ............... Включен', '🔴 Выключатель ............... Выключен') }}
            
            {{ iif(is_state('binary_sensor.toplight_hall_light_is_on', 'on'), '🟠 Освещение .................. Включено', '🟢 Освещение .................. Выключено') }}
            {{ iif(is_state('binary_sensor.backlight_hall_light_is_on', 'on'), '🟢 Подсветка .................... Включена', '🟠 Подсветка .................... Выключена') }}
            {{ iif(is_state('binary_sensor.nightlight_hall_light_is_on', 'on'), '🟠 Ночник ......................... Включен', '🟢 Ночник ......................... Выключен') }}
          data:
            inline_keyboard: 
            - 'Назад:/menu, Закрыть:/hideMenu'

    show_telegramm_bedroom_menu: 
      sequence:
      - service: notify.telegram_home_group_id
        data_template:
          message: | 
            🛌 Спальня

            {{ iif(is_state('binary_sensor.t_bedroom_air_is_normal', 'on'), '🟢', '🔴') }} Температура ................. {{ states('sensor.t_bedroom') }} °C
            {{ iif(is_state('binary_sensor.h_bedroom_is_normal', 'on'), '🟢', '🔴') }} Влажность ..................... {{ states('sensor.h_bedroom') }} %
            {{ iif(is_state('binary_sensor.p_living_is_normal', 'on'), '🟢', '🟠') }} Давление ....................... {{ states('sensor.p_bedroom') }} мм
            {{ iif(is_state('binary_sensor.solar_bedroom_sun_is_hit', 'on'), '🟠 Солнце ........................... Светит в окна', '🟢 Солнце ........................... Не попадает в окна') }}
            🔵 Положение шторы ........ {{ states('sensor.curtain_bedroom_position') }} %
            
            {{ iif(is_state('binary_sensor.ventilation_bedroom_left_window_virtual', 'on'), '🟠 Левое окно .................... Открыто', '🟢 Левое окно .................... Закрыто') }}
            {{ iif(is_state('binary_sensor.ventilation_bedroom_right_window_virtual', 'on'), '🟠 Правое окно .................. Открыто', '🟢 Правое окно .................. Закрыто') }}
            {{ iif(is_state('binary_sensor.ventilation_bedroom_entry_door_virtual', 'on'), '🔵 Дверь в комнату ........... Открыта', '🔵 Дверь в комнату ........... Закрыта') }}

            {{ iif(is_state('fan.hydration_bedroom_humidifier', 'on'), '🟢 Увлажнитель .................. Включен', '🟠 Увлажнитель .................. Выключен') }}
            {{ iif(is_state('binary_sensor.hydration_bedroom_humidifier_is_empty', 'on'), '🔴 Вода в увлажнителе ...... Закончилась', '🔵 Вода в увлажнителе ...... Недоступно') }}

            {{ iif(is_state('switch.bedroom_switch_right', 'on'), '🟢 Левый выключатель ...... Включен', '🔴 Левый выключатель ...... Выключен') }}
            {{ iif(is_state('switch.bedroom_switch_left', 'on'), '🟢 Правый выключатель .... Включен', '🔴 Правый выключатель .... Выключен') }}

            {{ iif(is_state('binary_sensor.toplight_bedroom_light_is_on', 'on'), '🟠 Освещение .................... Включено', '🟢 Освещение .................... Выключено') }}
            {{ iif(is_state('binary_sensor.backlight_bedroom_light_is_on', 'on'), '🟢 Подсветка ...................... Включена', '🟠 Подсветка ...................... Выключена') }}
          data:
            inline_keyboard: 
            - 'Назад:/menu, Закрыть:/hideMenu'

    show_telegramm_living_menu: 
      sequence:
      - service: notify.telegram_home_group_id
        data_template:
          message: | 
            📚 Гостиная

            {{ iif(is_state('binary_sensor.t_living_air_is_normal', 'on'), '🟢', '🔴') }} Температура ............... {{ states('sensor.t_living') }} °C
            {{ iif(is_state('binary_sensor.h_living_is_normal', 'on'), '🟢', '🔴') }} Влажность ................... {{ states('sensor.h_living') }} %
            {{ iif(is_state('binary_sensor.p_living_is_normal', 'on'), '🟢', '🟠') }} Давление ..................... {{ states('sensor.p_living') }} мм
            {{ iif(is_state('binary_sensor.solar_living_sun_is_hit', 'on'), '🟠 Солнце ......................... Светит в окна', '🟢 Солнце ......................... Не попадает в окна') }}
            🔵 Положение шторы ...... {{ states('sensor.curtain_living_position') }} %

            {{ iif(is_state('binary_sensor.ventilation_living_balcony_window_virtual', 'on'), '🟠 Окно ............................. Открыто', '🟢 Окно ............................. Закрыто') }}
            {{ iif(is_state('binary_sensor.ventilation_living_entry_door_virtual', 'on'), '🔵 Дверь в комнату .......... Открыта', '🔵 Дверь в комнату .......... Закрыта') }}

            {{ iif(is_state('switch.living_switch_right', 'on'), '🟢 Левый выключатель .... Включен', '🔴 Левый выключатель .... Выключен') }}
            {{ iif(is_state('switch.living_switch_left', 'on'), '🟢 Правый выключатель .. Включен', '🔴 Правый выключатель .. Выключен') }}

            {{ iif(is_state('fan.hydration_living_humidifier', 'on'), '🟢 Увлажнитель ................ Включен', '🟠 Увлажнитель ................ Выключен') }}
            {{ iif(is_state('binary_sensor.hydration_living_humidifier_is_empty', 'on'), '🔴 Вода в увлажнителе .... Закончилась', '🔵 Вода в увлажнителе .... Недоступно') }}

            {{ iif(is_state('binary_sensor.toplight_living_light_is_on', 'on'), '🟠 Освещение .................. Включено', '🟢 Освещение .................. Выключено') }}
            {{ iif(is_state('binary_sensor.backlight_living_light_is_on', 'on'), '🟢 Подсветка .................... Включена', '🟠 Подсветка .................... Выключена') }}
          data:
            inline_keyboard: 
            - 'Назад:/menu, Закрыть:/hideMenu'

    show_telegramm_balcony_menu: 
      sequence:
      - service: notify.telegram_home_group_id
        data_template:
          message:  | 
            {{ now().strftime('%H:%M %d-%m-%Y') }}
            🪴 Балкон

            🔵 Температура ........... {{ states('sensor.t_balcony') }} °C
            🔵 Влажность ............... {{ states('sensor.h_balcony') }} %
            🔵 Освещенность ......... {{ states('sensor.sun_illuminance_virtual') }} Lx

            {{ iif(is_state('switch.ventilation_living_balcony_door_virtual', 'on'), '🟠 Дверь на балкон ...... Открыта', '🟢 Дверь на балкон ...... Закрыта') }}

            {{ iif(is_state('switch.balcony_socket', 'on'), '🟠 Розетка ..................... Включена', '🟢 Розетка ..................... Выключена') }}
            {{ iif(is_state('fan.balcony_fountain', 'on'), '🟠 Фонтан ...................... Включен', '🟢 Фонтан ...................... Выключен') }}

            {{ iif(is_state('light.balcony_light_relay_l2', 'on'), '🟠 Освещение ............... Включено', '🟢 Освещение ............... Выключено') }}
            {{ iif(is_state('light.balcony_bottom_light', 'on'), '🟠 Подсветка ................. Включена', '🟢 Подсветка ................. Выключена') }}
          data:
            inline_keyboard: 
            - 'Назад:/home, Закрыть:/hideMenu'

