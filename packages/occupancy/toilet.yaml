occupancy_toilet:
  input_boolean:
    occupancy_toilet:

  timer:
    occupancy_toilet:
      duration: 00:00:10

  input_number:
    occupancy_toilet: 
      max: 60
      min: 1
      # 10

  template:
  - binary_sensor:
    - name: occupancy_toilet
      unique_id: occupancy_toilet
      device_class: occupancy
      state: "{{ is_state('input_boolean.occupancy_toilet', 'on') }}"

  - sensor:
    - name: occupancy_toilet_duration
      unique_id: occupancy_toilet_duration
      state: >
        {% set duration = states('input_number.occupancy_toilet') | int(0) %}
        {{ duration | timestamp_custom('%H:%M:%S', false) }}

  automation:
  - alias: occupancy_toilet_turn_on
    mode: queued
    trigger:
    - platform: state
      entity_id: binary_sensor.contact_toilet_door_virtual
      from: "off"
      to: "on"
    condition:
    - condition: state
      entity_id: input_boolean.occupancy_toilet
      state: "off"
    action:
    - parallel:
      - service: input_boolean.turn_on
        entity_id: input_boolean.occupancy_toilet
      - service: timer.start
        entity_id: timer.occupancy_toilet
        data_template:
          duration: "{{ states('sensor.occupancy_toilet_duration') }}"

  - alias: occupancy_toilet_turn_off
    mode: queued
    trigger:
    - platform: state
      entity_id: binary_sensor.contact_toilet_door_virtual
      from: "on"
      to: "off"
    condition:
    - condition: state
      entity_id: input_boolean.occupancy_toilet
      state: "on"
    - condition: state
      entity_id: timer.occupancy_toilet
      state: "idle"
    action:
    - service: input_boolean.turn_off
      entity_id: input_boolean.occupancy_toilet

  - alias: occupancy_toilet_timer_cancel
    mode: queued
    trigger:
    - platform: state
      entity_id: binary_sensor.contact_toilet_door_virtual
      from: "on"
      to: "off"
    condition:
    - condition: state
      entity_id: input_boolean.occupancy_toilet
      state: "on"
    - condition: state
      entity_id: timer.occupancy_toilet
      state: "active"
    action:
    - service: timer.cancel
      entity_id: timer.occupancy_toilet
