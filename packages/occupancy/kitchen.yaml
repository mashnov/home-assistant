occupancy_kicthen:
  input_boolean:
    occupancy_kitchen:

  timer:
    occupancy_kitchen:
      duration: 00:00:10
    
  input_number:
    occupancy_kitchen_day:
      # 00:04:00
      max: 10
      min: 1

    occupancy_kitchen_night: 
      # 00:00:30
      step: 0.5
      max: 10
      min: 0

  template:
  - binary_sensor:
    - name: occupancy_kitchen_virtual
      unique_id: occupancy_kitchen_virtual
      device_class: motion
      state: "{{ is_state('binary_sensor.kitchen_motion_occupancy', 'on') }}"

    - name: occupancy_kitchen
      unique_id: occupancy_kitchen
      device_class: occupancy
      state: "{{ is_state('input_boolean.occupancy_kitchen', 'on') }}"

  - sensor:
    - name: occupancy_kitchen_duration
      unique_id: occupancy_kitchen_duration
      state: >
        {% set isNightMode = is_state('input_boolean.is_night_mode', 'on') %}
        {% set nightValue = states('input_number.occupancy_kitchen_day') | int(0) %}
        {% set dayValue = states('input_number.occupancy_kitchen_day') | int(0) %}
        {% set value = iif(isNightMode, nightValue, dayValue) %}
        {% set duration = value * 60 %}
        {{ duration | timestamp_custom('%H:%M:%S', false) }}

  automation:
  - alias: occupancy_kitchen_turn_on
    mode: queued
    trigger:
    - platform: state
      entity_id: binary_sensor.occupancy_kitchen_virtual
      from: "off"
      to: "on"
    action:
    - parallel:
      - service: timer.cancel
        entity_id: timer.occupancy_kitchen
      - service: input_boolean.turn_on
        entity_id: input_boolean.occupancy_kitchen

  - alias: occupancy_kitchen_timer_start
    mode: queued
    trigger:
    - platform: state
      entity_id: binary_sensor.occupancy_kitchen_virtual
      from: "on"
      to: "off"
    action:
    - service: timer.start
      entity_id: timer.occupancy_kitchen
      data_template:
        duration: "{{ states('sensor.occupancy_kitchen_duration') }}"

  - alias: occupancy_kitchen_turn_off
    mode: queued
    trigger:
    - platform: event
      event_type: timer.finished
      event_data:
        entity_id: timer.occupancy_kitchen
    action:
    - service: input_boolean.turn_off
      entity_id: input_boolean.occupancy_kitchen

  - alias: occupancy_kitchen_timer_cancel
    mode: queued
    trigger:
    - platform: state
      entity_id: input_boolean.occupancy_kitchen
      from: "on"
      to: "off"
    action:
    - service: timer.cancel
      entity_id: timer.occupancy_kitchen
