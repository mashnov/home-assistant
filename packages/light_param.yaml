light_param:
  template:
  - sensor:      
    - name: 'light_param_temperature'
      unique_id: light_param_temperature
      state: >
        {% set minValue = 175 %}
        {% set maxValue = 333 %}
        {% set target = states('sensor.climat_illuminance_max') | int(1) %}
        {% set sensor = states('sensor.climat_illuminance_virtual') | int(0) %}
        {% set percent = min((sensor / max(1, target) ) * 100, 100) | round %}
        {% set temperature = (maxValue / 100 * (100 - percent)) | round %}
        {{ max(minValue, temperature) }}

    - name: 'light_param_shi_brightness'
      unique_id: light_param_shi_brightness
      state: >
        {% set isNightMode = is_state('input_boolean.is_night_mode', 'on') %}
        {% set nightValue = 50 %}
        {% set dayValue = 255 %}
        {{ iif(isNightMode, nightValue, dayValue) }}

  automation:
  - alias: 'light_params_kitchen'
    mode: 'queued'
    trigger:
    - platform: state
      entity_id: 'light.xiaomi_light_kitchen'
      to: 'on'
    - platform: state
      entity_id: 'sensor.light_param_temperature'
    action:
    - choose:
      - conditions:
        - condition: state
          entity_id: light.xiaomi_light_kitchen
          state: 'on'
        sequence:
        - service: light.turn_on
          entity_id: light.xiaomi_light_kitchen
          data_template:
            brightness: "255"
            color_temp: "{{ states('sensor.light_param_temperature') | int(333) }}"

  - alias: 'light_params_hall'
    mode: 'queued'
    trigger:
    - platform: state
      entity_id: 'light.xiaomi_light_hall'
      to: 'on'
    - platform: state
      entity_id: 'sensor.light_param_temperature'
    action:
    - choose:
      - conditions:
        - condition: state
          entity_id: light.xiaomi_light_hall
          state: 'on'
        sequence:
        - service: light.turn_on
          entity_id: light.xiaomi_light_hall
          data_template:
            brightness: "255"
            color_temp: "{{ states('sensor.light_param_temperature') | int(333) }}"

  - alias: 'light_params_bedroom'
    mode: 'queued'
    trigger:
    - platform: state
      entity_id: 'light.xiaomi_light_bedroom'
      to: 'on'
    - platform: state
      entity_id: 'sensor.light_param_temperature'
    action:
    - choose:
      - conditions:
        - condition: state
          entity_id: light.xiaomi_light_bedroom
          state: 'on'
        sequence:
        - service: light.turn_on
          entity_id: light.xiaomi_light_bedroom
          data_template:
            brightness: "255"
            color_temp: "{{ states('sensor.light_param_temperature') | int(333) }}"

  - alias: 'light_params_living'
    mode: 'queued'
    trigger:
    - platform: state
      entity_id: 'light.xiaomi_light_living'
      to: 'on'
    - platform: state
      entity_id: 'sensor.light_param_temperature'
    action:
    - choose:
      - conditions:
        - condition: state
          entity_id: light.xiaomi_light_living
          state: 'on'
        sequence:
        - service: light.turn_on
          entity_id: light.xiaomi_light_living
          data_template:
            brightness: "255"
            color_temp: "{{ states('sensor.light_param_temperature') | int(333) }}"

  - alias: 'light_param_night_light_hall'
    mode: 'queued'
    trigger:
    - platform: state
      entity_id: 'light.night_light_hall'
      to: 'on'
    - platform: state
      entity_id: 'sensor.light_param_shi_brightness'
    - platform: state
      entity_id: 'sensor.light_param_shi_saturation'
    action:
    - choose:
      - conditions:
        - condition: state
          entity_id: light.night_light_hall
          state: 'on'
        sequence:
        - service: light.turn_on
          entity_id: light.night_light_hall
          data_template:
            brightness: "{{ states('sensor.light_param_shi_brightness') | int(50) }}"
            hs_color: [24, 95]
