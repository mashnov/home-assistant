notification_homepod:
  tts: 
  - platform: edge_tts
    service_name: sveta_say
    language: ru-RU-SvetlanaNeural
    cache: false

  input_number:
    notification_homepod_volume_current:
      max: 1
      min: 0
    notification_homepod_volume_night: # 0.1
      max: 1
      min: 0
    notification_homepod_volume_day: # 0.4
      max: 1
      min: 0

  template:
  - sensor:
    - name: 'notification_homepod_volume'
      state: >
        {% set isNightMode = is_state('binary_sensor.night_mode_hall', 'on') %}
        {% set nightValue = states('input_number.notification_homepod_volume_night') %}
        {% set dayValue = states('input_number.notification_homepod_volume_day') %}
        {{ iif(isNightMode, nightValue, dayValue) | int(0) }}

  script:
    notification_homepod:
      mode: 'queued'
      sequence:
      - service: input_number.set_value
        data_template:
          entity_id: input_number.notification_homepod_volume_current
          value: "{{ state_attr('media_player.homepod', 'volume_level') }}"
      - service: media_player.volume_set
        data_template:
          entity_id: media_player.homepod
          volume_level: "{{ states('sensor.notification_homepod_volume') }}"
      - service: tts.sveta_say
        data:
          entity_id: media_player.homepod
          message: "{{ message }}"
          cache: false
      - service: media_player.volume_set
        data_template:
          entity_id: media_player.homepod
          volume_level: "{{ states('input_number.notification_homepod_volume_current') }}"

    notification_homepod_test:
      mode: 'queued'
      sequence:
      - service: script.notification_homepod
        data_template:
          message: "Тестовое уведомление"
