hygrostat:
  generic_hygrostat:
  - name: dehumidifier_bath
    device_class: 'dehumidifier'
    humidifier: switch.relay_toilet_l1
    target_sensor: sensor.humidity_bath_virtual

  - name: humidifier_hall
    device_class: 'humidifier'
    humidifier: switch.relay_hall_l2
    target_sensor: sensor.humidity_hall_virtual

  - name: humidifier_bedroom
    device_class: 'humidifier'
    humidifier: switch.relay_bedroom_l2
    target_sensor: sensor.humidity_bedroom_virtual

  - name: humidifier_living
    device_class: 'humidifier'
    humidifier: switch.relay_living_l1
    target_sensor: sensor.humidity_living_virtual

  input_number:
    hygrostat_hall_power_offset: # 12
      max: 60
      min: 0
    
    hygrostat_bedroom_power_offset: # 12
      max: 60
      min: 0
    
    hygrostat_living_power_offset: # 10
      max: 60
      min: 0

  template:
  - binary_sensor:
    - name: 'hygrostat_hall_is_empty'
      device_class: 'moisture'
      delay_on: '00:00:10'
      state: >
        {% set humidifier = is_state('switch.relay_hall_l2', 'on') %}
        {% set backlight = is_state('light.back_light_hall', 'on') %}
        {% set offset = states('input_number.hygrostat_hall_power_offset') | int(0) %}
        {% set power = states('sensor.relay_hall_power') | float(0) | round(0) %}
        {% set sensor = iif(backlight, power - offset, power) %}
        {{ humidifier and (sensor <= 0) }}
    
    - name: 'hygrostat_bedroom_is_empty'
      device_class: 'moisture'
      delay_on: '00:00:10'
      state: >
        {% set humidifier = is_state('switch.relay_bedroom_l2', 'on') %}
        {% set backlight = is_state('light.back_light_bedroom', 'on') %}
        {% set offset = states('input_number.hygrostat_bedroom_power_offset') | int(0) %}
        {% set power = states('sensor.relay_bedroom_power') | float(0) | round(0) %}
        {% set sensor = iif(backlight, power - offset, power) %}
        {{ humidifier and (sensor <= 0) }}
    
    - name: 'hygrostat_living_is_empty'
      device_class: 'moisture'
      delay_on: '00:00:10'
      state: >
        {% set humidifier = is_state('switch.relay_living_l1', 'on') %}
        {% set backlight = is_state('light.back_light_living', 'on') %}
        {% set offset = states('input_number.hygrostat_living_power_offset') | int(0) %}
        {% set power = states('sensor.relay_living_power') | float(0) | round(0) %}
        {% set sensor = iif(backlight, power - offset, power) %}
        {{ humidifier and (sensor <= 0) }}

  automation:
  - alias: 'humidifier_hall'
    mode: 'queued'
    trigger:
    - id: 'humidifier_hall_on'
      platform: state
      entity_id: 'binary_sensor.is_ventilation_kitchen'
      from: 'on'
      to: 'off'
    - id: 'humidifier_hall_off'
      platform: state
      entity_id: 'binary_sensor.is_ventilation_kitchen'
      from: 'off'
      to: 'on'
    action:
    - choose:
      - conditions:
        - condition: trigger
          id: 'humidifier_hall_on'
        sequence:
        - service: humidifier.turn_on
          entity_id: humidifier.humidifier_hall
      - conditions:
        - condition: trigger
          id: 'humidifier_hall_off'
        sequence:
        - service: humidifier.turn_off
          entity_id: humidifier.humidifier_hall

  - alias: 'humidifier_bedroom'
    mode: 'queued'
    trigger:
    - id: 'humidifier_bedroom_on'
      platform: state
      entity_id: 'binary_sensor.is_ventilation_bedroom'
      from: 'on'
      to: 'off'
    - id: 'humidifier_bedroom_on'
      platform: state
      entity_id: 'input_boolean.is_night_mode'
      from: 'on'
      to: 'off'
    - id: 'humidifier_bedroom_off'
      platform: state
      entity_id: 'binary_sensor.is_ventilation_bedroom'
      from: 'off'
      to: 'on'
    - id: 'humidifier_bedroom_off'
      platform: state
      entity_id: 'input_boolean.is_night_mode'
      from: 'off'
      to: 'on'
    action:
    - choose:
      - conditions:
        - condition: trigger
          id: 'humidifier_bedroom_on'
        - condition: state
          entity_id: input_boolean.is_night_mode
          state: 'off'
        sequence:
        - service: humidifier.turn_on
          entity_id: humidifier.humidifier_bedroom
      - conditions:
        - condition: trigger
          id: 'humidifier_bedroom_off'
        sequence:
        - service: humidifier.turn_off
          entity_id: humidifier.humidifier_bedroom

  - alias: 'humidifier_living'
    mode: 'queued'
    trigger:
    - id: 'humidifier_living_on'
      platform: state
      entity_id: 'binary_sensor.is_ventilation_living'
      from: 'on'
      to: 'off'
    - id: 'humidifier_living_off'
      platform: state
      entity_id: 'binary_sensor.is_ventilation_living'
      from: 'off'
      to: 'on'
    action:
    - choose:
      - conditions:
        - condition: trigger
          id: 'humidifier_living_on'
        sequence:
        - service: humidifier.turn_on
          entity_id: humidifier.humidifier_living
      - conditions:
        - condition: trigger
          id: 'humidifier_living_off'
        sequence:
        - service: humidifier.turn_off
          entity_id: humidifier.humidifier_living
